<?php
//include du fichier GESTION pour les objets (Modeles)
include 'Modele/Gestion.php';

//classe CONTROLEUR qui redirige vers les bonnes vues les bonnes informations
Class Controleur
	{
	//ATTRIBUTS PRIVES-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	private $maGestion;

	//CONSTRUCTEUR------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	public function __construct()
		{
		$this->maGestion = new Gestion();
		}		
	
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//---------------------------METHODE D'AFFICHAGE DE L'ENTETE-----------------------------------------------------------------------------------------------------------------------------------------------------------------
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	public function afficheEntete()
		{
		//appel de la vue de l'entête
		require 'Vues/entete.php';
		}	
		
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	
	//---------------------------METHODE D'AFFICHAGE DU PIED DE PAGE------------------------------------------------------------------------------------------------------------------------------------------------------------
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	public function affichePiedPage()
		{
		//appel de la vue du pied de page
		require 'Vues/piedPage.php';
		}	
		
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//--------------------------METHODE D'AFFICHAGE DU MENU-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	public function afficheMenu()
		{
		//appel de la vue du menu
		require 'Vues/menu.php';
		}	
	
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//--------------------------METHODE D'AFFICHAGE DES VUES----------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	public function affichePage($action,$vue)
		{
		//SELON la vue demandée
		switch ($vue)
			{
			case "panier":
				$this->vuePanier($action);
				break;
			case "produit":
				$this->vueProduit($action);
				break;
			case "accueil":
				session_destroy();
				break;
			}
		}			
			
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//----------------------------PANIER--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	private function vuePanier($action)
		{
		//SELON l'action demandée
		switch ($action)
			{	
			
			//CAS création d'un panier------------------------------------------------------------------------------------------------------
			case "creer" :
				if(isset($_SESSION['lesContenus']))
					{
					for($i=0;$i<count($_SESSION['lesContenus']);$i++)
						{
						$resSplit=explode("#",$_SESSION['lesContenus'][$i]);
						$pdt=$resSplit[0];
						$_SESSION['lesProduitsPre'][$i]=$this->maGestion->lesProduitsDansBaliseSELECT($pdt);
						}
					}
				$_SESSION['lesProduits']=$this->maGestion->lesProduitsDansBaliseSELECT(null);
				$_SESSION['laDate']=$this->next_day(4);
				require 'Vues/creerPanier.php';
				break;
				
			//CAS visualisation des paniers--------------------------------------------------------------------------------------------------
			case "visualiser" :
				$_SESSION['lesPaniers']=$this->maGestion->lesPaniersDansBaliseSELECT();
				require 'Vues/voirPaniers.php';
				break;
				
			//CAS enregistrement d'un panier dans la base------------------------------------------------------------------------------
			case "enregistrer" :
				if(isset($_POST['annuler']))
					{
					unset($_SESSION['lesContenus']);
					unset($_SESSION['lesProduitsPre']);
					$this->vuePanier('creer');
					}
				else
					{
					$lesContenus=array();
					if(isset($_SESSION['lesContenus']))
						$lesContenus=$_SESSION['lesContenus'];
					$lesContenus[count($lesContenus)]=$_POST['listeProduits']."#".$_POST['qte'];
					$_SESSION['lesContenus']=$lesContenus;
					/***********************************************************************/
					/*                  Extrait du fichier Controleur.php                  */
					/*                 vue = panier & action = enregistrer                 */
					/*        chaque commentaire explique l'instruction qui le suit        */
					/***********************************************************************/
					//Si on a cliqué sur le bouton "Valider"
					if(isset($_POST['valider']))
						{
						//On récupère la date saisie
						$d = $_POST['laDate'];
						//Si il n'existe pas de panier pour la date saisie
						if(!$this->maGestion->panierExistant($d))
							{
							//ALORS le panier pour la date saisie est créé
							$this->maGestion->ajouteUnPanier($d);
							}
						//POUR chacune des lignes de contenu (code produit + quantite) saisie
						// (ces lignes ont été ajoutées dans la variable 
						// de session $_SESSION['lesContenus'] au fur et à mesure 
						// que l'utilisateur a cliqué sur le bouton "Ajouter un produit")
						for($i=0;$i<count($_SESSION['lesContenus']);$i++)
							{
							//La méthode explode() retourne une sous chaine extraite d'un tableau de chaînes. 
							// Chaque chaine "explosée" est une sous-chaîne de la variable $_SESSION['lesContenus']
							$resSplit=explode("#",$_SESSION['lesContenus'][$i]);
							//On récupère le code produit...
							$pdt=$resSplit[0];
							//...et la quantité
							$qte=$resSplit[1];
							//On ajoute la ligne courante de contenu
							$_SESSION['ok']=$this->maGestion->ajouteUnContenu($pdt,$d,$qte);
							}
						//affichage de la vue (qui affichera le contenu de $_SESSION['ok']
						require 'Vues/message.php';
					/***********************************************************************/
					/*                         Fin de l'extrait                            */
					/***********************************************************************/
						unset($_SESSION['lesContenus']);
						unset($_SESSION['lesProduitsPre']);
						
						$_SESSION['Controleur'] = serialize($this);
						}
					else
						{
						if(isset($_POST['ajout']))
							{
							$this->vuePanier('creer');
							}
						}
					}		
				break;
			}
		}
		
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//----------------------------PRODUIT-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	private function vueProduit($action)
		{
		//SELON l'action demandée
		switch ($action)
			{	
			
			}
		}	
		
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//----------------------------fonction permettant de trouver la date du prochain jour voulu..-------------------------------------------------------------------------------------------------------------------------------------------------------
	//----------------------------(lundi=1, mardi=2, mercredi=3, jeudi=4, vendredi=5, samedi=6 et dimanche=7)..----------------------------------------------------------------------------------------------------------------------------------------
	//----------------------------Retourne la date au format : aaaa-mm-jj.-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	private function next_day($day_number)
		{
		  for ($i = 2; $i <= 8; $i++)
		  {
			$next_day = mktime(0,0,0, date("m"), date("d")+$i, date("Y"));
			if(date("w",$next_day)==$day_number)
			{
			  $XDate = getdate($next_day);
			  $next_day_fund = sprintf('%02d', $XDate['year']).'-'.sprintf('%02d', $XDate['mon']).'-'.sprintf('%02d', $XDate['mday']);
			}
		  }
		  return $next_day_fund;
		}
		
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//----------------------------fonction permettant de recuperer les infos via ajax-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	
	public function executeRequeteSQLpourAJAX($uneRequete)
		{
		return $this->maGestion->executeRequeteSQLpourAJAX($uneRequete);
		}
	}	
?>